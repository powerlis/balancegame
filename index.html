<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“š ë°¸ëŸ°ìŠ¤ ë…ì„œ ê²Œì„ â€“ ì‹¤ì‹œê°„ ë©€í‹°í”Œë ˆì´</title>
  <style>
    /* ====== ì²¨ë¶€ íŒŒì¼ì˜ ë””ìŠ¤í”Œë ˆì´ ìŠ¤íƒ€ì¼ ê³„ìŠ¹ ====== */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

    :root {
      --main-color: #4a044e; /* Deep Purple */
      --light-color: #f3e8ff; /* Light Purple */
      --dark-color: #3b0764;  /* Darker Purple */
      --bg-color: #fdfcff;    /* Off-white */
      --text-dark: #1f2937;
      --text-light: #6b7280;
      --border-color: #e5e7eb;
      --radius: 20px;
    }

    *{ box-sizing:border-box }
    html, body { height: 100% }
    body {
      font-family: 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Malgun Gothic, Arial, sans-serif;
      background-color: var(--bg-color);
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }

    /* ì „ì²´ ì•± ì»¨í…Œì´ë„ˆ: ì¹´ë“œ ëŠë‚Œ ìœ ì§€ + ë°˜ì‘í˜• í­ í™•ì¥ */
    #app {
      background-color: #fff;
      width: 100%;
      max-width: 920px;           /* ë‹¨ì¼Â·ë©€í‹° ë ˆì´ì•„ì›ƒ ëª¨ë‘ ìˆ˜ìš© */
      border-radius: var(--radius);
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .pad { padding: 24px 22px }
    .head { padding: 26px 22px 10px; text-align: center; }
    .pill {
      display:inline-block;
      background-color: var(--light-color);
      color: var(--main-color);
      font-weight: 700;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
    }
    h1 {
      color: var(--dark-color);
      font-size: clamp(22px, 4.6vw, 32px);
      margin: 10px 0 6px;
    }
    p.lead {
      color: var(--text-light);
      margin: 0 0 8px;
      line-height: 1.6;
    }

    /* ì…ë ¥/í¼ */
    .row{ display:flex; gap:12px; flex-wrap: wrap }
    .col{ flex:1; min-width:260px }
    input[type="text"]{
      width:100%;
      padding:14px 14px;
      border-radius: 14px;
      border:2px solid var(--border-color);
      background:#fff;
      color:var(--text-dark);
      font-size: 1rem;
    }
    input[type="text"]:focus{
      outline:none; border-color: var(--main-color);
      box-shadow: 0 0 0 3px rgba(74,4,78,0.12);
    }

    /* ë²„íŠ¼ (ì²¨ë¶€ ìŠ¤íƒ€ì¼ ìœ ì§€) */
    .btn {
      display:block;
      width:100%;
      padding:16px;
      margin-top: 10px;
      border:2px solid var(--main-color);
      border-radius: 15px;
      background-color: var(--main-color);
      color:#fff;
      font-size:1.1rem;
      font-weight:700;
      cursor:pointer;
      transition: all .2s ease;
    }
    .btn:hover { background-color: var(--dark-color); border-color: var(--dark-color); transform: translateY(-2px); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; transform:none }

    /* ì˜µì…˜ ë²„íŠ¼ì€ í° ë°°ê²½ + ë³´ë¼ í…ìŠ¤íŠ¸(ì²¨ë¶€ answer-btn ìŠ¤íƒ€ì¼) */
    .opt {
      background:#fff;
      color:var(--main-color);
      border:2px solid var(--main-color);
      text-align:center;
      padding:16px;
      border-radius: 15px;
      font-weight:700;
      margin-bottom:12px;
      width:100%;
      cursor:pointer;
      transition: all .15s ease;
    }
    .opt:hover { background: var(--light-color); color: var(--dark-color); border-color: var(--dark-color); }
    .opt.selected { outline: 3px solid var(--light-color); }

    /* ì¹´ë“œ */
    .card { border-top: 1px solid var(--border-color); }

    /* ì§„í–‰ ë§‰ëŒ€ */
    .progress {
      width: 100%; height: 10px; background: var(--border-color); border-radius: 5px; overflow: hidden; margin-bottom: 16px;
    }
    .progress .bar {
      width:0%; height:100%; background: var(--main-color); transition: width .35s ease;
    }

    /* í…ìŠ¤íŠ¸ */
    .muted { color: var(--text-light) }
    .tag {
      display:inline-block;
      border:1px solid var(--border-color);
      padding:6px 10px;
      border-radius:999px;
      background:#f9fafb;
      margin:4px 6px 0 0;
      font-size: .95rem;
    }

    /* í‘œ (ê²°ê³¼ìš©) */
    table { width:100%; border-collapse: collapse }
    th, td { border:1px solid var(--border-color); padding:8px 10px; text-align: center }
    th { background:#f8fafc }

    /* ë°°ë„ˆ/ê²½ê³  */
    .banner { width:100%; max-width:920px; margin: 10px auto 0; }
    .error {
      background:#fef2f2; border:1px solid #fecaca; color:#991b1b;
      padding:10px 12px; border-radius: 12px; margin-bottom: 12px; white-space: pre-wrap;
    }

    /* í˜ì´ì§€ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ ëŠë‚Œ */
    .fadeIn { animation: fadeIn .35s ease }
    @keyframes fadeIn { from{opacity:0; transform: translateY(8px)} to{opacity:1; transform:none} }
  </style>
</head>
<body>
  <div class="banner" id="banner"></div>

  <div id="app" class="fadeIn">
    <!-- JS ë Œë” -->
  </div>

  <!-- Firebase SDK (CDN/compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
  /* ======================= ìƒíƒœ/ìœ í‹¸ ======================= */
  const appEl = document.getElementById('app');
  const banner = document.getElementById('banner');
  const $ = (s,c=document)=>c.querySelector(s);
  const uid = ()=>'P'+Math.random().toString(36).slice(2,8).toUpperCase();
  const code6 = ()=>Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(2,8);

  let me = { id:null, name:'', role:'player' };
  let room = { id:null, secret:null };
  let db = null, firebaseReady = false;

  let unsubRoom = null, unsubPlayers = null, unsubAnswers = null;
  let subscribedIndex = null;

  let latestRoomData = null;
  let latestPlayers = [];
  let curIndex = 0;

  /* ======================= ì§ˆë¬¸(2ì„ íƒ ë°¸ëŸ°ìŠ¤ 10ë¬¸í•­) ======================= */
  const QUESTIONS = [
    { id:'Q1', title:'ì±…ê°ˆí”¼ê°€ ì—†ì„ ë•Œ?', options:[
      { text:'a. ì±… ëª¨ì„œë¦¬ ì ‘ìœ¼ë©´ ê°„ë‹¨í•˜ì§€', type:'A' },
      { text:'b. ìƒˆ ì±… ëŠë‚Œ ì§€ì¼œ! ì ˆëŒ€ ì ‘ì§€ ì•ŠëŠ”ë‹¤', type:'B' }
    ]},
    { id:'Q2', title:'ì½ì—ˆë˜ ì±…ì„ ë‹¤ì‹œ ë³¼ ê¸°íšŒê°€ ìˆë‹¤ë©´?', options:[
      { text:'a. ìƒˆë¡œìš´ ëŠë‚Œìœ¼ë¡œ ë‹¤ì‹œ ì½ìœ¼ë©´ ì¬ë°Œê² ë‹¤.', type:'A' },
      { text:'b. í•œë²ˆ ë³¸ ì±…ì„ ì™œ ë˜ ë´„?', type:'B' }
    ]},
    { id:'Q3', title:'ì±… ì½ëŠ” ì¤‘ê°„ì— ë°©í•´ë°›ìœ¼ë©´?', options:[
      { text:'a. ë­ ì–´ë•Œ, ì‹ ê²½ ë„ê³  ì´ì–´ì„œ ì½ìœ¼ë©´ ë˜ì§€', type:'A' },
      { text:'b. ì•„, ì§€ê¸ˆì€ ì½ì„ íƒ€ì´ë°ì´ ì•„ë‹Œê°€? ë‹¤ìŒì— ì½ì–´ì•¼ì§€.', type:'B' }
    ]},
    { id:'Q4', title:'ëª…ëŒ€ì‚¬ë¥¼ ë°œê²¬í•˜ë©´?', options:[
      { text:'a. ì´ê±´ ì¸ìƒ ë¬¸ì¥! ì¸ë±ìŠ¤ ë¶™ì´ê³  ê¸°ë¡í•´ì•¼ì§€', type:'A' },
      { text:'b. ìŒ.. ì¢‹ë„¤...(ê·¸ëƒ¥ ë§ˆìŒì—ë§Œ ë‹´ì•„ë‘”ë‹¤)', type:'B' }
    ]},
    { id:'Q5', title:'í´ë¼ì´ë§¥ìŠ¤ì—ì„œ ì ì´ ì˜¬ ë•Œ?', options:[
      { text:'a. ì¡¸ë¦¬ë©´ ê·¸ëƒ¥ ì”ë‹¤ (ë…ì„œ=ìˆ˜ë©´ì œ)', type:'A' },
      { text:'b. ì´ì•¼ê¸° íë¦„ ì§€ì¼œ! ëê¹Œì§€ ë²„í‹´ë‹¤', type:'B' }
    ]},
    { id:'Q6', title:'ì±…ì„ ê³ ë¥¼ ë•Œ ë‚˜ëŠ”?', options:[
      { text:'a. ê°ìœ¼ë¡œ ê³ ë¥¸ë‹¤ (í‘œì§€, ì œëª©, ëŠë‚Œ!)', type:'A' },
      { text:'b. ë¦¬ë·°/ì¶”ì²œì„ ê¼¼ê¼¼íˆ ë³´ê³  ê³ ë¥¸ë‹¤', type:'B' }
    ]},
    { id:'Q7', title:'ì±…ì— ë¬¼ì´ë‚˜ ì–¼ë£©ì´ ë¬»ì—ˆë‹¤ë©´?', options:[
      { text:'a. ë§ˆìŒì˜ ìƒì²˜, ìƒˆë¡œ ì‚¬ê³  ì‹¶ë‹¤', type:'A' },
      { text:'b. ì¶”ì–µì˜ í”ì ì´ë¼ ìƒê°í•œë‹¤', type:'B' }
    ]},
    { id:'Q8', title:'ë‚˜ëŠ” ë‚´ ì±…ì— ì´ë¦„ì„...', options:[
      { text:'a. ê¼­ ì ëŠ”ë‹¤(ë‚´ ì†Œì¤‘í•œ ì±…ì´ë‹ˆê¹Œ)', type:'A' },
      { text:'b. ì ˆëŒ€ ì•ˆ ì ëŠ”ë‹¤(ê¹¨ë—í•´ì•¼í•´!)', type:'B' }
    ]},
    { id:'Q9', title:'ë“±ì¥ì¸ë¬¼ì´ ë„ˆë¬´ ë§ë‹¤ë©´?', options:[
      { text:'a. ë©”ëª¨í•˜ê±°ë‚˜ í‘œì‹œí•´ë‘”ë‹¤', type:'A' },
      { text:'b. ê·¸ëƒ¥ ê°ìœ¼ë¡œ ê¸°ì–µí•œë‹¤', type:'B' }
    ]},
    { id:'Q10', title:'ì¹œêµ¬ê°€ ë‚´ê²Œ ì±…ì„ ë¹Œë ¤ë‹¬ë¼ í•˜ë©´?', options:[
      { text:'a. ê°™ì´ ì½ì! ê¸°êº¼ì´ ë¹Œë ¤ì¤€ë‹¤', type:'A' },
      { text:'b. ì±… í—¤ì§€ë©´ ì†ìƒí•´â€¦ ì‚´ì§ ë§ì„¤ì¸ë‹¤', type:'B' }
    ]}
  ];

  /* ======================= ì‹œì‘ í™”ë©´ ======================= */
  function renderStart(){
    appEl.innerHTML = `
      <div class="head">
        <span class="pill">íœ´ëŒ€í° ì°¸ì—¬ Â· ì‹¤ì‹œê°„</span>
        <h1>ë°¸ëŸ°ìŠ¤ ë…ì„œ ê²Œì„</h1>
        <p class="lead">í˜¸ìŠ¤íŠ¸ëŠ” ë°©ì„ ë§Œë“¤ê³ , ì°¸ê°€ìëŠ” ë°© ì½”ë“œë¡œ ì…ì¥í•©ë‹ˆë‹¤.</p>
      </div>
      <div class="pad card">
        <div class="row">
          <div class="col">
            <label class="muted" for="hostName">í˜¸ìŠ¤íŠ¸ ì´ë¦„</label>
            <input id="hostName" type="text" placeholder="ì˜ˆ: ì‚¬íšŒì/êµì‚¬" />
            <button class="btn" id="mkroom">ë°© ë§Œë“¤ê¸°</button>
          </div>
          <div class="col">
            <label class="muted" for="code">ë°© ì½”ë“œ & ì°¸ê°€ì ì´ë¦„</label>
            <input id="code" type="text" placeholder="ë°© ì½”ë“œ(ì˜ˆ: ABC123)" />
            <input id="name" type="text" placeholder="ë‚´ ì´ë¦„(ì°¸ê°€ì)" style="margin-top:10px" />
            <button class="btn" id="join">ì°¸ê°€ìë¡œ ì…ì¥</button>
          </div>
        </div>
        <p class="muted" style="margin:14px 4px 0">Firestore ìƒíƒœ: <b>${firebaseReady?'ì—°ê²°ë¨':'ë¯¸ì—°ê²°(ì½˜ì†”/ê·œì¹™ í™•ì¸)'}</b></p>
      </div>
    `;

    $('#mkroom').addEventListener('click', async ()=>{
      if(!firebaseReady) return showErr('Firebaseê°€ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ì–´ìš”. í”„ë¡œì íŠ¸/ê·œì¹™ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
      const name = $('#hostName').value.trim() || 'Host';
      try { await createRoom(name); } catch(e){ showErr('ë°© ë§Œë“¤ê¸° ì‹¤íŒ¨: '+(e?.message||e)); }
    });

    $('#join').addEventListener('click', async ()=>{
      if(!firebaseReady) return showErr('Firebaseê°€ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ì–´ìš”. í”„ë¡œì íŠ¸/ê·œì¹™ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
      const code = $('#code').value.trim().toUpperCase();
      const name = $('#name').value.trim() || 'ì°¸ê°€ì';
      if(!code) return showErr('ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      try { await joinRoom(code, name); } catch(e){ showErr('ì…ì¥ ì‹¤íŒ¨: '+(e?.message||e)); }
    });
  }

  function showErr(msg){
    banner.innerHTML = `<div class="error">âš ï¸ ${msg}</div>`;
    console.error(msg);
  }

  /* ======================= Firebase ì—°ê²° ======================= */
  (function connectFirebase(){
    try{
      const cfg = {
        apiKey: "AIzaSyApSfouaSStrJ7YKjjU-V3YByqO0cd_AIc",
        authDomain: "balancegame-43c9b.firebaseapp.com",
        projectId: "balancegame-43c9b",
        storageBucket: "balancegame-43c9b.appspot.com",
        messagingSenderId: "334047765801",
        appId: "1:334047765801:web:50a37aa30ed5b0f06bc338",
        measurementId: "G-GEWHJK9SP3"
      };
      if(!(window.firebase && firebase.initializeApp)){
        showErr("Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬/CSP ì°¨ë‹¨ ê°€ëŠ¥)");
        renderStart(); return;
      }
      firebase.initializeApp(cfg);
      db = firebase.firestore();
      firebaseReady = true;

      // ì ‘ê·¼ í™•ì¸ìš©(ê¶Œí•œ ì—†ìœ¼ë©´ ì—ëŸ¬ ë…¸ì¶œ)
      db.collection("_ping").limit(1).get()
        .then(()=>renderStart())
        .catch(e=>{ showErr("Firestore ì ‘ê·¼ ì‹¤íŒ¨: ì½˜ì†” ê·œì¹™ì„ Publish í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.\n"+(e?.message||e)); renderStart(); });
    }catch(e){
      showErr("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜: "+(e?.message||e));
      renderStart();
    }
  })();

  /* ======================= Firestore I/O ======================= */
  async function createRoom(hostName){
    const id = code6();
    const secret = Math.random().toString(36).slice(2,10);
    await db.collection('rooms').doc(id).set({
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      currentIndex: -1,
      started: false,
      hostId: null,
      secret,
    });
    room.id = id; room.secret = secret;
    me = { id: uid(), name: hostName, role:'host' };
    await db.collection('rooms').doc(id).collection('players').doc(me.id).set({
      name: me.name, role:'host',
      joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    await db.collection('rooms').doc(id).update({ hostId: me.id });
    listenRoom();
  }

  async function joinRoom(code, name){
    const snap = await db.collection('rooms').doc(code).get();
    if(!snap.exists){ showErr('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°© ì½”ë“œì…ë‹ˆë‹¤.'); return; }
    room.id = code; room.secret = snap.data().secret || null;
    me = { id: uid(), name, role:'player' };
    await db.collection('rooms').doc(code).collection('players').doc(me.id).set({
      name: me.name, role:'player',
      joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    listenRoom();
  }

  function listenRoom(){
    if (unsubRoom) unsubRoom();
    unsubRoom = db.collection('rooms').doc(room.id).onSnapshot(doc=>{
      if(!doc.exists){ showErr('ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); renderStart(); return; }
      latestRoomData = doc.data();
      renderGame(latestRoomData, latestPlayers);
    });

    if (unsubPlayers) unsubPlayers();
    unsubPlayers = db.collection('rooms').doc(room.id).collection('players')
      .orderBy('joinedAt','asc')
      .onSnapshot(snap=>{
        latestPlayers = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        if(latestRoomData) renderGame(latestRoomData, latestPlayers);
      });
  }

  async function answersFor(index){
    const qs = await db.collection('rooms').doc(room.id).collection('answers').where('qIndex','==',index).get();
    return qs.docs.map(d=>d.data());
  }

  async function startGame(){
    await db.collection('rooms').doc(room.id).update({ started:true, currentIndex:0 });
  }

  async function nextQuestionSafe(cur){
    const ref = db.collection('rooms').doc(room.id);
    await db.runTransaction(async tx=>{
      const snap = await tx.get(ref);
      if(!snap.exists) throw new Error('room not found');
      const now = snap.data().currentIndex ?? -1;
      if(now===cur){
        tx.update(ref, { currentIndex: Math.min(cur+1, QUESTIONS.length) });
      }
    });
  }

  async function pick(index, type){
    const docId = `${me.id}_${index}`;
    return db.collection('rooms').doc(room.id).collection('answers').doc(docId).set({
      playerId: me.id, name: me.name, qIndex: index, type,
      at: firebase.firestore.FieldValue.serverTimestamp(),
    }, { merge:true });
  }

  /* ======================= í™”ë©´ ë Œë” ======================= */
  async function renderGame(roomDoc, players){
    const cur = roomDoc.currentIndex;
    curIndex = cur;

    // í˜„ì¬ ë¬¸í•­ answers ì‹¤ì‹œê°„ êµ¬ë…(ì „ì› ì‘ë‹µ ê°ì§€)
    if (cur >= 0 && cur < QUESTIONS.length) {
      if (subscribedIndex !== cur) {
        if (unsubAnswers) { unsubAnswers(); unsubAnswers = null; }
        subscribedIndex = cur;
        unsubAnswers = db.collection('rooms').doc(room.id)
          .collection('answers').where('qIndex','==',cur)
          .onSnapshot(()=>{ if(latestRoomData) renderGame(latestRoomData, latestPlayers); });
      }
    } else {
      if (unsubAnswers) { unsubAnswers(); unsubAnswers = null; }
      subscribedIndex = null;
    }

    const head = `
      <div class="head">
        <span class="pill">ë°© ì½”ë“œ ${room.id||'-'}</span>
        <h1>ë°¸ëŸ°ìŠ¤ ë…ì„œ ê²Œì„</h1>
        <p class="lead">${players.length}ëª… ì°¸ì—¬ ì¤‘</p>
      </div>
    `;

    // ëŒ€ê¸°ì‹¤
    if(cur < 0 || !roomDoc.started){
      appEl.innerHTML = `
        ${head}
        <div class="pad card">
          <h3 style="margin:0 0 6px">ëŒ€ê¸°ì‹¤</h3>
          <p class="muted">ë§í¬ë¥¼ ê³µìœ í•˜ê³  <b>ë°© ì½”ë“œ</b>ë¡œ ì…ì¥í•˜ì„¸ìš”.</p>
          <div style="margin:10px 0 6px">
            ${players.length ? players.map(p=>`<span class="tag">${p.name}${p.role==='host'?' (í˜¸ìŠ¤íŠ¸)':''}</span>`).join(' ') : '<span class="muted">ì•„ì§ ì°¸ê°€ì ì—†ìŒ</span>'}
          </div>
          ${me.role==='host' ? '<button class="btn" id="start">ê²Œì„ ì‹œì‘</button>' : ''}
        </div>
      `;
      if(me.role==='host') $('#start').addEventListener('click', startGame);
      return;
    }

    // ê²°ê³¼ í™”ë©´
    if(cur >= QUESTIONS.length){
      const allAnsSnap = await db.collection('rooms').doc(room.id).collection('answers').get();
      const answers = allAnsSnap.docs.map(d=>d.data());
      const qCount = QUESTIONS.length;

      // ë‘ ì°¸ê°€ì ê°„ ë§¤ì¹­ëœ ë¬¸ì œ ëª©ë¡
      function pairMatches(aId, bId){
        const list=[];
        for(let i=0;i<qCount;i++){
          const Pa = answers.find(x=>x.playerId===aId && x.qIndex===i);
          const Pb = answers.find(x=>x.playerId===bId && x.qIndex===i);
          if(Pa && Pb && Pa.type===Pb.type){
            const optType = Pa.type;
            const optText = QUESTIONS[i].options.find(o=>o.type===optType)?.text || (optType==='A'?'a.':'b.');
            list.push({ index:i, title: QUESTIONS[i].title, type: optType, text: optText });
          }
        }
        return list;
      }
      function matchMessage(n){
        if(n<=2) return { title:'ì±…ì€ ê°™ì´ ì½ì§€ë§Œ... ë§ˆìŒì€ í‰í–‰ì„  ğŸ’«', desc:'ì™„ì „ ë°˜ëŒ€ ì·¨í–¥ì´ì§€ë§Œ ê·¸ë˜ì„œ ë” ì¬ë°Œì–´ìš”! ëŒ€í™”í•  ê±°ë¦¬ ê°€ë“í•œ ì¡°í•©.' };
        if(n<=5) return { title:'ë‹¤ë¥´ì§€ë§Œ ë¬˜í•˜ê²Œ í†µí•˜ëŠ” ë…ì„œ ì¹œêµ¬ ğŸ“–', desc:'ê´€ì ì€ ë‹¬ë¼ë„ ì„œë¡œ ì¡´ì¤‘í•˜ëŠ” ì´ìƒì ì¸ ë“€ì˜¤.' };
        if(n<=8) return { title:'ê°™ì´ íë§í•˜ëŠ” ì°ë…ì„œë©”ì´íŠ¸ ğŸŒ¿', desc:'ì½ëŠ” ìŠµê´€/ì·¨í–¥ì´ ë¹„ìŠ·! ì„œê°€ì—ì„œë„ ìì£¼ ë§ˆì£¼ì¹˜ëŠ” íƒ€ì….' };
        return { title:'ë…ì„œ ì†Œìš¸ë©”ì´íŠ¸ ë°œê²¬! ğŸ’', desc:'ì±… ì†ì—ì„œë„ ë§Œë‚  ìš´ëª…! ì·¨í–¥ ì‹±í¬ê°€ ì™„ë²½í•©ë‹ˆë‹¤.' };
      }

      // ì „ì²´ ë§¤ì¹­ í‘œ
      const playersNow = players;
      let table = '<table><thead><tr><th>ìƒëŒ€</th>';
      playersNow.forEach(p=> table += `<th>${p.name}</th>`);
      table += '</tr></thead><tbody>';
      playersNow.forEach(r=>{
        table += `<tr><th>${r.name}</th>`;
        playersNow.forEach(c=>{
          if(r.id===c.id) table += '<td>â€”</td>';
          else {
            const s = pairMatches(r.id,c.id).length;
            const rate = Math.round((s/qCount)*100);
            table += `<td>${s}/${qCount} (${rate}%)</td>`;
          }
        });
        table += '</tr>';
      });
      table += '</tbody></table>';

      // í˜ì–´ ì¹´ë“œ(ë§¤ì¹­ëœ ë¬¸ì œ + A/B ë³´ê¸°ê¹Œì§€)
      let pairCards = '';
      if(playersNow.length>=2){
        for(let i=0;i<playersNow.length;i++){
          for(let j=i+1;j<playersNow.length;j++){
            const A = playersNow[i], B = playersNow[j];
            const matches = pairMatches(A.id,B.id);
            const msg = matchMessage(matches.length);
            const listHTML = matches.length
              ? `<ol style="margin:.4rem 0 0 1.2rem;padding:0">
                    ${matches.map(x=>`
                      <li style="margin:.2rem 0">
                        <b>Q${x.index+1}.</b> ${x.title}<br/>
                        <span class="tag">ê³µí†µ ì„ íƒ: ${x.type}</span>
                        <span class="tag">${x.text}</span>
                      </li>`).join('')}
                 </ol>`
              : `<p class="muted" style="margin:.4rem 0 0">ë§¤ì¹­ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            pairCards += `
              <div class="pad card" style="margin-top:12px; border-radius:${'calc(var(--radius) - 6px)'}">
                <span class="pill">${A.name} Ã— ${B.name}</span>
                <h3 style="margin:.6rem 0 0">ì¼ì¹˜ ${matches.length}/${qCount}</h3>
                <p class="muted" style="margin:.2rem 0 .4rem">${msg.title}</p>
                <p>${msg.desc}</p>
                <div class="pad" style="background:#f9fafb; border:1px solid var(--border-color); border-radius:14px; margin-top:8px">
                  <h4 style="margin:.2rem 0 .4rem">ë§¤ì¹­ëœ ë¬¸ì œ ëª©ë¡</h4>
                  ${listHTML}
                </div>
              </div>
            `;
          }
        }
      }

      appEl.innerHTML = `
        ${head}
        <div class="pad card">
          <h3 style="margin:0 0 10px">ì·¨í–¥ ê²¹ì¹¨(ê°™ì€ íƒ€ì… ì„ íƒ ë¹„ìœ¨)</h3>
          ${table}
          ${pairCards ? `<div class="pad card" style="margin-top:14px"><h3 style="margin:0 0 8px">í˜ì–´ ë§¤ì¹­ ìƒì„¸</h3>${pairCards}</div>`:''}
          <button class="btn" id="restart" style="margin-top:14px">ë‹¤ì‹œ í•˜ê¸°(ìƒˆ ë°©)</button>
        </div>
      `;
      $('#restart').addEventListener('click', ()=>location.reload());
      return;
    }

    // ì§„í–‰ í™”ë©´ (ì‹¤ì‹œê°„ ì§‘ê³„/ì‚¬ì´ë“œ ì œê±°)
    const q = QUESTIONS[cur];
    const picks = await answersFor(cur);
    const myPick = picks.find(a=>a.playerId===me.id)?.type || null;

    // ì „ì› ì‘ë‹µ í™•ì¸
    const answeredIds = new Set(picks.map(p=>p.playerId));
    const allAnswered = players.every(p=>answeredIds.has(p.id));

    appEl.innerHTML = `
      ${head}
      <div class="pad card">
        <div class="progress"><div class="bar" style="width:${Math.round((cur/QUESTIONS.length)*100)}%"></div></div>
        <div class="muted" style="margin-bottom:6px">ë¬¸í•­ ${cur+1} / ${QUESTIONS.length}</div>
        <h2 style="color:var(--text-dark); font-size:1.35rem; margin: 0 0 14px">${q.title}</h2>

        ${q.options.map(o=>`
          <button type="button" class="opt ${myPick===o.type?'selected':''}" data-type="${o.type}">
            ${o.text}
          </button>
        `).join('')}

        <p class="muted" style="margin:10px 0 0">ì„ íƒì„ ì™„ë£Œí•˜ë©´ í˜¸ìŠ¤íŠ¸ê°€ ë‹¤ìŒ ë¬¸í•­ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.</p>

        ${ me.role==='host'
            ? `<button class="btn" id="nextHost" ${!allAnswered?'disabled title="ëª¨ë‘ ì‘ë‹µí•´ì•¼ ì§„í–‰ ê°€ëŠ¥"':''} style="margin-top:12px">ë‹¤ìŒ(í˜¸ìŠ¤íŠ¸)</button>`
            : '' }
      </div>
    `;

    // í˜¸ìŠ¤íŠ¸ë§Œ ì§„í–‰ ë²„íŠ¼
    const btnHost = $('#nextHost');
    if(btnHost){
      btnHost.addEventListener('click', ()=>{
        if(allAnswered) nextQuestionSafe(cur);
      });
    }
  }

  // ì˜µì…˜ ë²„íŠ¼(ë™ì ) â€” ì´ë²¤íŠ¸ ìœ„ì„
  if(!window.__optDelegated){
    appEl.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.opt');
      if(!btn) return;

      // í‘œì‹œ
      appEl.querySelectorAll('.opt').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');

      if(!firebaseReady || !db) { alert(`(í…ŒìŠ¤íŠ¸) ${btn.textContent} ì„ íƒ`); return; }

      try{
        await pick(curIndex, btn.dataset.type);
        // onSnapshotìœ¼ë¡œ ìë™ ë¦¬ë Œë”
      }catch(err){
        showErr('ì„ íƒ ì €ì¥ ì‹¤íŒ¨: ' + (err?.message||err));
      }
    });
    window.__optDelegated = true;
  }

  // ì´ˆê¸° ë Œë”
  renderStart();

  // ì „ì—­ ì—ëŸ¬
  window.addEventListener('error', e=>{ showErr("ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜: " + (e?.message||e)); });
  </script>

  <!-- â–¼ Firestore ê·œì¹™(í…ŒìŠ¤íŠ¸ìš© ì˜ˆì‹œ) â€“ ì½˜ì†” > Firestore Database > Rulesì—ì„œ Publish
  // ë°ëª¨/í…ŒìŠ¤íŠ¸ì—ì„œë§Œ ì‚¬ìš©í•˜ì„¸ìš”. ìš´ì˜ ì „ì—ëŠ” ì¸ì¦/ì œí•œì„ ë°˜ë“œì‹œ ì ìš©í•˜ì„¸ìš”.
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /{document=**} { allow read, write: if true; }
    }
  }
  â–² -->
</body>
</html>
