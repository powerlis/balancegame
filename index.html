<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ“š ë°¸ëŸ°ìŠ¤ ë…ì„œ ê²Œì„ â€“ ì„ì‹¤ê³ ë“±í•™êµ ë„ì„œê´€</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

    :root {
      --main-color: #4a044e;
      --light-color: #f3e8ff;
      --dark-color: #3b0764;
      --bg-color: #fdfcff;
      --text-dark: #1f2937;
      --text-light: #6b7280;
      --border-color: #e5e7eb;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; overflow-x: hidden; }
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: var(--bg-color);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    #app {
      background-color: #fff;
      width: 100%;
      max-width: 920px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      overflow: hidden;
    }

    .head { text-align: center; padding: 24px 20px 10px; }
    .pill {
      display:inline-block;
      background-color: var(--light-color);
      color: var(--main-color);
      padding: 6px 14px;
      border-radius: 999px;
      font-weight:700;
      font-size:13px;
    }
    h1 { color: var(--dark-color); font-size: clamp(22px,4.6vw,32px); margin:10px 0 6px; }
    .lead { color: var(--text-light); margin: 0 0 12px; }

    .pad { padding: 24px 22px; }
    .card { border-top: 1px solid var(--border-color); }

    .btn {
      display:block; width:100%;
      padding:15px;
      border:2px solid var(--main-color);
      border-radius:15px;
      background-color:var(--main-color);
      color:white; font-size:1.1rem;
      font-weight:700; cursor:pointer;
      transition:all .2s ease;
      margin-top:10px;
    }
    .btn:hover { background-color:var(--dark-color); border-color:var(--dark-color); transform:translateY(-2px); }
    .btn[disabled]{opacity:.6;cursor:not-allowed;transform:none;}

    input[type="text"]{
      width:100%; padding:14px;
      border-radius:14px; border:2px solid var(--border-color);
      font-size:1rem; margin-bottom:10px;
    }
    input[type="text"]:focus{
      border-color:var(--main-color); outline:none;
      box-shadow:0 0 0 3px rgba(74,4,78,0.1);
    }

    .muted{ color:var(--text-light); }

    .progress{ width:100%; height:10px; background:var(--border-color);
      border-radius:5px; overflow:hidden; margin-bottom:16px;}
    .bar{ height:100%; background:var(--main-color); transition:width .35s ease;}

    /* ì„ íƒ ë²„íŠ¼ (A/B) */
    .opt {
      position: relative;
      width:100%; padding:16px;
      margin-bottom:12px;
      border:2px solid var(--main-color);
      border-radius:15px;
      background:#fff;
      color:var(--main-color);
      font-weight:700;
      text-align:center;
      cursor:pointer;
      transition: all .2s ease;
    }
    .opt:hover { background: var(--light-color); color: var(--dark-color); border-color: var(--dark-color); }
    .opt:active { transform: scale(0.98); }
    .opt.selected {
      background: var(--main-color);
      color: #fff;
      border-color: var(--dark-color);
      box-shadow: 0 6px 16px rgba(74,4,78,.25);
    }
    .opt.selected::after {
      content: "âœ“ ì„ íƒë¨";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: #fff;
      color: var(--main-color);
      padding: 4px 10px;
      border-radius: 999px;
      border: 2px solid var(--main-color);
      font-size: 0.9rem;
      font-weight: 700;
    }

    .tag{display:inline-block;padding:4px 8px;margin:2px;
      border-radius:999px;background:#f3f4f6;color:#374151;font-size:0.9rem;}

    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border:1px solid var(--border-color);padding:8px;text-align:center;}
    th{background:#f9fafb;}
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
  const $ = (s,c=document)=>c.querySelector(s);
  const uid = ()=>Math.random().toString(36).slice(2,9);
  const code6 = ()=>Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(2,8);

  let db, me={id:null,role:'player'}, room={id:null};
  let unsubRoom=null, unsubPlayers=null, unsubAnswers=null, subscribedIndex=null;
  let latestRoomData=null, latestPlayers=[];

  const QUESTIONS = [
    {title:'ì±…ê°ˆí”¼ê°€ ì—†ì„ ë•Œ?',a:'a. ì±… ëª¨ì„œë¦¬ ì ‘ìœ¼ë©´ ê°„ë‹¨í•˜ì§€',b:'b. ìƒˆ ì±… ëŠë‚Œ ì§€ì¼œ! ì ˆëŒ€ ì ‘ì§€ ì•ŠëŠ”ë‹¤'},
    {title:'ì½ì—ˆë˜ ì±…ì„ ë‹¤ì‹œ ë³¼ ê¸°íšŒê°€ ìˆë‹¤ë©´?',a:'a. ìƒˆë¡œìš´ ëŠë‚Œìœ¼ë¡œ ë‹¤ì‹œ ì½ìœ¼ë©´ ì¬ë°Œê² ë‹¤.',b:'b. í•œë²ˆ ë³¸ ì±…ì„ ì™œ ë˜ ë´„?'},
    {title:'ì±… ì½ëŠ” ì¤‘ê°„ì— ë°©í•´ë°›ìœ¼ë©´?',a:'a. ë­ ì–´ë•Œ, ì‹ ê²½ ë„ê³  ì´ì–´ì„œ ì½ìœ¼ë©´ ë˜ì§€',b:'b. ì•„, ì§€ê¸ˆì€ ì½ì„ íƒ€ì´ë°ì´ ì•„ë‹Œê°€? ë‹¤ìŒì— ì½ì–´ì•¼ì§€.'},
    {title:'ëª…ëŒ€ì‚¬ë¥¼ ë°œê²¬í•˜ë©´?',a:'a. ì´ê±´ ì¸ìƒ ë¬¸ì¥! ì¸ë±ìŠ¤ ë¶™ì´ê³  ê¸°ë¡í•´ì•¼ì§€',b:'b. ìŒ.. ì¢‹ë„¤...(ê·¸ëƒ¥ ë§ˆìŒì—ë§Œ ë‹´ì•„ë‘”ë‹¤)'},
    {title:'í´ë¼ì´ë§¥ìŠ¤ì—ì„œ ì ì´ ì˜¬ ë•Œ?',a:'a. ì¡¸ë¦¬ë©´ ê·¸ëƒ¥ ì”ë‹¤ (ë…ì„œ=ìˆ˜ë©´ì œ)',b:'b. ì´ì•¼ê¸° íë¦„ ì§€ì¼œ! ëê¹Œì§€ ë²„í‹´ë‹¤'},
    {title:'ì±…ì„ ê³ ë¥¼ ë•Œ ë‚˜ëŠ”?',a:'a. ê°ìœ¼ë¡œ ê³ ë¥¸ë‹¤ (í‘œì§€, ì œëª©, ëŠë‚Œ!)',b:'b. ë¦¬ë·°/ì¶”ì²œì„ ê¼¼ê¼¼íˆ ë³´ê³  ê³ ë¥¸ë‹¤'},
    {title:'ì±…ì— ë¬¼ì´ë‚˜ ì–¼ë£©ì´ ë¬»ì—ˆë‹¤ë©´?',a:'a. ë§ˆìŒì˜ ìƒì²˜, ìƒˆë¡œ ì‚¬ê³  ì‹¶ë‹¤',b:'b. ì¶”ì–µì˜ í”ì ì´ë¼ ìƒê°í•œë‹¤'},
    {title:'ë‚˜ëŠ” ë‚´ ì±…ì— ì´ë¦„ì„...',a:'a. ê¼­ ì ëŠ”ë‹¤(ë‚´ ì†Œì¤‘í•œ ì±…ì´ë‹ˆê¹Œ)',b:'b. ì ˆëŒ€ ì•ˆ ì ëŠ”ë‹¤(ê¹¨ë—í•´ì•¼í•´!)'},
    {title:'ë“±ì¥ì¸ë¬¼ì´ ë„ˆë¬´ ë§ë‹¤ë©´?',a:'a. ë©”ëª¨í•˜ê±°ë‚˜ í‘œì‹œí•´ë‘”ë‹¤',b:'b. ê·¸ëƒ¥ ê°ìœ¼ë¡œ ê¸°ì–µí•œë‹¤'},
    {title:'ì¹œêµ¬ê°€ ë‚´ê²Œ ì±…ì„ ë¹Œë ¤ë‹¬ë¼ í•˜ë©´?',a:'a. ê°™ì´ ì½ì! ê¸°êº¼ì´ ë¹Œë ¤ì¤€ë‹¤',b:'b. ì±… í—¤ì§€ë©´ ì†ìƒí•´â€¦ ì‚´ì§ ë§ì„¤ì¸ë‹¤'}
  ];

  // ğŸ”¹ Firebase ì—°ê²°
  firebase.initializeApp({
    apiKey:"AIzaSyApSfouaSStrJ7YKjjU-V3YByqO0cd_AIc",
    authDomain:"balancegame-43c9b.firebaseapp.com",
    projectId:"balancegame-43c9b"
  });
  db=firebase.firestore();

  // ğŸ”¹ ì‹œì‘ í™”ë©´
  function renderStart(){
    app.innerHTML=`
    <div class="head">
      <span class="pill">ì„ì‹¤ê³ ë“±í•™êµ ë„ì„œê´€</span>
      <h1>ë°¸ëŸ°ìŠ¤ ë…ì„œ ê²Œì„</h1>
      <p class="lead">í˜¸ìŠ¤íŠ¸ëŠ” ë°©ì„ ë§Œë“¤ê³ , ì°¸ê°€ìëŠ” ë°© ì½”ë“œë¡œ ì…ì¥í•©ë‹ˆë‹¤.</p>
    </div>
    <div class="pad card">
      <label>í˜¸ìŠ¤íŠ¸ ì´ë¦„</label>
      <input id="hostName" type="text" placeholder="ì˜ˆ: ì‚¬íšŒì" />
      <button class="btn" id="mkroom">ë°© ë§Œë“¤ê¸°</button>
      <hr style="margin:20px 0;border:none;border-top:1px solid var(--border-color)">
      <label>ë°© ì½”ë“œ</label>
      <input id="code" type="text" placeholder="ABC123" />
      <label>ì°¸ê°€ì ì´ë¦„</label>
      <input id="name" type="text" placeholder="ì´ë¦„" />
      <button class="btn" id="join">ì°¸ê°€ìë¡œ ì…ì¥</button>
    </div>`;
    $('#mkroom').onclick=async()=>{
      const name=$('#hostName').value.trim()||'Host';
      const id=code6();
      await db.collection('rooms').doc(id).set({createdAt:firebase.firestore.FieldValue.serverTimestamp(),started:false,currentIndex:-1});
      me={id:uid(),name,role:'host'}; room.id=id;
      await db.collection('rooms').doc(id).collection('players').doc(me.id).set({name,role:'host'});
      listenRoom();
    };
    $('#join').onclick=async()=>{
      const code=$('#code').value.trim().toUpperCase(), name=$('#name').value.trim();
      const snap=await db.collection('rooms').doc(code).get();
      if(!snap.exists){alert('ì—†ëŠ” ë°©ì…ë‹ˆë‹¤');return;}
      me={id:uid(),name,role:'player'}; room.id=code;
      await db.collection('rooms').doc(code).collection('players').doc(me.id).set({name,role:'player'});
      listenRoom();
    };
  }

  async function listenRoom(){
    if(unsubRoom)unsubRoom(); if(unsubPlayers)unsubPlayers();
    unsubRoom=db.collection('rooms').doc(room.id).onSnapshot(doc=>{
      latestRoomData=doc.data(); renderGame();
    });
    unsubPlayers=db.collection('rooms').doc(room.id).collection('players').onSnapshot(snap=>{
      latestPlayers=snap.docs.map(d=>({id:d.id,...d.data()})); renderGame();
    });
  }

  async function answersFor(i){
    const snap=await db.collection('rooms').doc(room.id).collection('answers').where('qIndex','==',i).get();
    return snap.docs.map(d=>d.data());
  }

  async function pick(i,type){
    const id=`${me.id}_${i}`;
    await db.collection('rooms').doc(room.id).collection('answers').doc(id).set({playerId:me.id,qIndex:i,type});
  }

  async function startGame(){
    await db.collection('rooms').doc(room.id).update({started:true,currentIndex:0});
  }

  async function nextQuestion(i){
    await db.collection('rooms').doc(room.id).update({currentIndex:i+1});
  }

  async function renderGame(){
    if(!latestRoomData)return;
    const cur=latestRoomData.currentIndex;
    const players=latestPlayers;

    // ëŒ€ê¸°ì‹¤
    if(!latestRoomData.started||cur<0){
      app.innerHTML=`
      <div class="head"><span class="pill">ë°© ì½”ë“œ ${room.id}</span>
      <h1>ëŒ€ê¸°ì‹¤</h1><p class="lead">${players.length}ëª… ì°¸ì—¬ ì¤‘</p></div>
      <div class="pad card">${players.map(p=>`<span class="tag">${p.name}</span>`).join('')}
      ${me.role==='host'?'<button class="btn" id="start">ê²Œì„ ì‹œì‘</button>':''}</div>`;
      if(me.role==='host')$('#start').onclick=startGame;
      return;
    }

    // ê²°ê³¼
    if(cur>=QUESTIONS.length){
      const all=await db.collection('rooms').doc(room.id).collection('answers').get();
      const ans=all.docs.map(d=>d.data());
      let html=`<div class="head"><span class="pill">ê²°ê³¼</span><h1>ë§¤ì¹­ ê²°ê³¼</h1></div><div class="pad card">`;
      for(let i=0;i<players.length;i++){
        for(let j=i+1;j<players.length;j++){
          const A=players[i],B=players[j];
          const same=QUESTIONS.filter((_,k)=>{
            const pa=ans.find(x=>x.playerId===A.id&&x.qIndex===k);
            const pb=ans.find(x=>x.playerId===B.id&&x.qIndex===k);
            return pa&&pb&&pa.type===pb.type;
          });
          html+=`<div class="pad card" style="margin-top:12px"><h3>${A.name} Ã— ${B.name} : ${same.length}/${QUESTIONS.length}</h3>
          ${same.map(s=>`<p><b>${s.title}</b><br>${s.a.includes('a.')?'ê³µí†µ ì„ íƒ: a':'ê³µí†µ ì„ íƒ: b'}</p>`).join('')||'<p>ë§¤ì¹­ ì—†ìŒ</p>'}</div>`;
        }
      }
      html+=`<button class="btn" onclick="location.reload()">ë‹¤ì‹œ í•˜ê¸°</button></div>`;
      app.innerHTML=html; return;
    }

    // ì§„í–‰ ì¤‘
    const q=QUESTIONS[cur];
    const picks=await answersFor(cur);
    const my=picks.find(p=>p.playerId===me.id)?.type;
    const answeredIds=new Set(picks.map(p=>p.playerId));
    const allAnswered=players.every(p=>answeredIds.has(p.id));

    app.innerHTML=`
    <div class="head"><span class="pill">ë¬¸í•­ ${cur+1}/${QUESTIONS.length}</span><h1>${q.title}</h1></div>
    <div class="pad card">
      <div class="opt ${my==='A'?'selected':''}" data-type="A">${q.a}</div>
      <div class="opt ${my==='B'?'selected':''}" data-type="B">${q.b}</div>
      ${me.role==='host'?`<button class="btn" id="next" ${!allAnswered?'disabled':''}>ë‹¤ìŒ</button>`:''}
    </div>`;

    if(me.role==='host'&&$('#next'))$('#next').onclick=()=>{if(allAnswered)nextQuestion(cur);}
  }

  // ì„ íƒ í´ë¦­ ì´ë²¤íŠ¸
  app.addEventListener('click',async e=>{
    const b=e.target.closest('.opt'); if(!b)return;
    app.querySelectorAll('.opt').forEach(x=>x.classList.remove('selected'));
    b.classList.add('selected');
    await pick(latestRoomData.currentIndex,b.dataset.type);
  });

  renderStart();
  </script>
</body>
</html>
