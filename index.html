<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>밸런스 독서 게임 – 실시간 멀티플레이</title>
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --ink:#1f2937; --muted:#6b7280;
      --brand:#3b82f6; --accent:#60a5fa; --ok:#16a34a; --warn:#eab308;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:"Noto Sans KR",sans-serif;
      background:var(--bg);color:var(--ink);padding:30px;
      display:flex;justify-content:center;
    }
    .card{
      background:var(--card);
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:20px;
      box-shadow:0 4px 15px rgba(0,0,0,.1);
      width:100%;max-width:640px;
    }
    .btn{
      appearance:none;border:0;border-radius:12px;padding:14px 18px;
      font-weight:700;background:linear-gradient(135deg,#3b82f6,#60a5fa);
      color:#fff;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.15);
      transition:0.2s
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .opt{display:block;width:100%;margin-top:10px;text-align:left}
    .selected{outline:3px solid var(--accent);filter:brightness(1.1)}
    .progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin:10px 0}
    .bar{height:100%;background:linear-gradient(90deg,var(--brand),var(--accent));transition:width .25s ease}
    .tag{border:1px solid #d1d5db;padding:6px 10px;border-radius:999px;background:#f3f4f6;display:inline-block;margin:4px}
  </style>
</head>
<body>
<div id="app" class="card">로딩 중...</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyApSfouaSStrJ7YKjjU-V3YByqO0cd_AIc",
  authDomain: "balancegame-43c9b.firebaseapp.com",
  projectId: "balancegame-43c9b",
  storageBucket: "balancegame-43c9b.appspot.com",
  messagingSenderId: "334047765801",
  appId: "1:334047765801:web:50a37aa30ed5b0f06bc338",
  measurementId: "G-GEWHJK9SP3"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const app=document.getElementById('app');
const QUESTIONS=[
 {id:'Q1',title:'책갈피가 없을 때?',options:[
  {text:'a. 책 모서리 접으면 간단하지',type:'A'},
  {text:'b. 새 책 느낌 지켜! 절대 접지 않는다',type:'B'}]},
 {id:'Q2',title:'읽었던 책을 다시 볼 기회가 있다면?',options:[
  {text:'a. 새로운 느낌으로 다시 읽으면 재밌겠다.',type:'A'},
  {text:'b. 한번 본 책을 왜 또 봄?',type:'B'}]}
];
let me={id:'HOST',role:'host',name:'호스트'};
let room={id:'TESTROOM'};

async function renderGame(index){
  const q=QUESTIONS[index];
  const snap=await db.collection('rooms').doc(room.id)
    .collection('answers').where('qIndex','==',index).get();
  const picks=snap.docs.map(d=>d.data());
  const players=await db.collection('rooms').doc(room.id).collection('players').get();
  const allPlayers=players.docs.map(d=>d.data());
  const allAnswered=picks.length>=allPlayers.length;
  const myPick=picks.find(p=>p.playerId===me.id)?.type||null;

  app.innerHTML=`
    <div class="progress"><div class="bar" style="width:${(index/QUESTIONS.length)*100}%"></div></div>
    <h3>${q.title}</h3>
    ${q.options.map(o=>`
      <button class="btn opt ${myPick===o.type?'selected':''}" data-type="${o.type}">
        ${o.text}
      </button>`).join('')}
    <p style="margin-top:10px">${picks.length}/${allPlayers.length} 응답 완료</p>
    ${allAnswered?'<div class="tag">모두 응답 완료!</div>':''}
    ${me.role==='host'?`<button id="nextBtn" class="btn" ${!allAnswered?'disabled':''}>다음(호스트)</button>`:''}
  `;
  document.querySelectorAll('.opt').forEach(b=>{
    b.onclick=async()=>{
      await db.collection('rooms').doc(room.id).collection('answers').doc(me.id+'_'+index)
      .set({playerId:me.id,qIndex:index,type:b.dataset.type});
      renderGame(index);
    };
  });
  const next=document.getElementById('nextBtn');
  if(next) next.onclick=()=>{if(allAnswered) renderGame(index+1)};
}

// 테스트용
(async()=>{
  await db.collection('rooms').doc(room.id).set({started:true});
  await db.collection('rooms').doc(room.id).collection('players').doc('HOST').set({name:'호스트'});
  await db.collection('rooms').doc(room.id).collection('players').doc('USER1').set({name:'참가자1'});
  await db.collection('rooms').doc(room.id).collection('players').doc('USER2').set({name:'참가자2'});
  renderGame(0);
})();
</script>
</body>
</html>
