<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë°¸ëŸ°ìŠ¤ ë…ì„œ ê²Œì„ â€“ ì‹¤ì‹œê°„ ë©€í‹°í”Œë ˆì´ (ê°œì„ ë³¸)</title>
  <style>
    :root{
      --bg:#0f1117; --card:#171923; --ink:#e9edf6; --muted:#a7b0c2;
      --brand:#7aa2ff; --accent:#64d2ff; --ok:#48e6a0; --warn:#ffd166; --bad:#ff6b6b;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:"Noto Sans KR",system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,Arial,sans-serif;
      background:
        radial-gradient(1200px 1200px at 15% -10%,rgba(122,162,255,.12),transparent 60%),
        radial-gradient(1200px 1200px at 110% 20%,rgba(100,210,255,.10),transparent 60%),
        var(--bg);
      color:var(--ink)
    }
    .wrap{max-width:980px;margin:0 auto;padding:28px 18px 80px}
    header{display:flex;align-items:center;gap:12px;margin:8px 0 18px}
    .pill{font-size:12px;color:#06101f;background:linear-gradient(135deg,var(--ok),#7bffeb);padding:6px 12px;border-radius:999px;font-weight:800;letter-spacing:.2px}
    h1{font-size:clamp(26px,5vw,40px);margin:.2rem 0 .2rem;line-height:1.15}
    p.lead{color:var(--muted);margin:.2rem 0 1.2rem;font-size:15px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);box-shadow:0 15px 40px rgba(0,0,0,.35);backdrop-filter: blur(8px);border-radius:var(--radius)}
    .card.pad{padding:22px}
    .grid{display:grid;gap:18px}
    @media(min-width:900px){.grid{grid-template-columns:1.4fr .8fr}}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:250px}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:var(--ink)}
    .muted{color:var(--muted)}

    /* ë²„íŠ¼ ê°€ë…ì„±/ì„ íƒ ê°•ì¡° ê°œì„  */
    .btn{
      appearance:none;border:0;border-radius:14px;padding:14px 18px;font-weight:800;
      background:linear-gradient(135deg,#4a90e2,#6cc4ff); color:#fff; /* í° ê¸€ì”¨ */
      cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,.30);
      transition:transform .05s ease,filter .2s ease,outline-color .2s ease;
    }
    .btn:hover{filter:brightness(1.1)}
    .btn:active{transform:translateY(1px)}
    .btn.block{width:100%}
    .btn.ghost{background:transparent;color:var(--ink);border:1px solid rgba(255,255,255,.18);box-shadow:none}
    .btn.selected{outline:3px solid #ffcc00;filter:brightness(1.2)}

    .notice{background:rgba(255,255,255,.08);padding:10px;border-radius:12px;margin-top:12px}
    .error{background:#2b0000;border:1px solid #ff8a8a;color:#ffdede;padding:10px;border-radius:10px;margin:10px 0;white-space:pre-wrap}

    .qnum{display:inline-block;font-weight:900;color:#0b1020;background:linear-gradient(135deg,#a0b7ff,#d0e3ff);padding:6px 10px;border-radius:999px;font-size:12px;margin-bottom:12px}
    .qtitle{font-size:20px;font-weight:900;margin:0 0 12px}
    .tag{border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);display:inline-block;margin:4px 6px 0 0}
    .progress{height:10px;border-radius:999px;background:rgba(255,255,255,.1);overflow:hidden;margin-bottom:10px}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#b3e5ff);transition:width .25s ease}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border:1px solid rgba(255,255,255,.15);padding:8px 10px;text-align:center}
    .table th{background:rgba(255,255,255,.06)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <span class="pill">íœ´ëŒ€í° ì°¸ì—¬ Â· ì‹¤ì‹œê°„</span>
      <div>
        <h1>ë°¸ëŸ°ìŠ¤ ë…ì„œ ê²Œì„ â€“ ì˜¨ë¼ì¸ ë™ì‹œ ì°¸ê°€</h1>
        <p class="lead">í˜¸ìŠ¤íŠ¸ê°€ ë°©ì„ ë§Œë“¤ê³ , ì°¸ê°€ìëŠ” ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ ê°ì íœ´ëŒ€í°ìœ¼ë¡œ ì°¸ì—¬í•©ë‹ˆë‹¤.</p>
      </div>
    </header>

    <div id="banner"></div>

    <main id="app" class="card pad" aria-live="polite">
      <!-- UI ë¨¼ì € ë Œë”, FirebaseëŠ” ë‚˜ì¤‘ì— ì—°ê²° -->
    </main>

    <footer class="muted" style="margin-top:10px;font-size:12px">
      Powered by Firebase Firestore (client-only demo). ì‹¤ì œ ìš´ì˜ ì‹œ ì¸ì¦Â·ê·œì¹™ì„ ê°•í™”í•˜ì„¸ìš”.
    </footer>
  </div>

  <!-- Firebase SDK (CDN/compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

  <script>
  // =============== ê³µí†µ ìƒíƒœ/ìœ í‹¸ ===============
  const appEl = document.getElementById('app');
  const banner = document.getElementById('banner');
  const $ = (s,c=document)=>c.querySelector(s);
  const uid = ()=>'P'+Math.random().toString(36).slice(2,8).toUpperCase();
  const code6 = ()=>Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(2,8);

  let me = { id:null, name:'', role:'player' };
  let room = { id:null, secret:null };
  let db = null;
  let firebaseReady = false;
  let unsubRoom = null, unsubPlayers = null;

  const QUESTIONS = [
    { id:'Q1', title:'ì±…ê°ˆí”¼ê°€ ì—†ì„ ë•Œ?', options:[
      { text:'a. ì±… ëª¨ì„œë¦¬ ì ‘ìœ¼ë©´ ê°„ë‹¨í•˜ì§€', type:'A' },
      { text:'b. ìƒˆ ì±… ëŠë‚Œ ì§€ì¼œ! ì ˆëŒ€ ì ‘ì§€ ì•ŠëŠ”ë‹¤', type:'B' }
    ]},
    { id:'Q2', title:'ì½ì—ˆë˜ ì±…ì„ ë‹¤ì‹œ ë³¼ ê¸°íšŒê°€ ìˆë‹¤ë©´?', options:[
      { text:'a. ìƒˆë¡œìš´ ëŠë‚Œìœ¼ë¡œ ë‹¤ì‹œ ì½ìœ¼ë©´ ì¬ë°Œê² ë‹¤.', type:'A' },
      { text:'b. í•œë²ˆ ë³¸ ì±…ì„ ì™œ ë˜ ë´„?', type:'B' }
    ]},
    { id:'Q3', title:'ì±… ì½ëŠ” ì¤‘ê°„ì— ë°©í•´ë°›ìœ¼ë©´?', options:[
      { text:'a. ë­ ì–´ë•Œ, ì‹ ê²½ ë„ê³  ì´ì–´ì„œ ì½ìœ¼ë©´ ë˜ì§€', type:'A' },
      { text:'b. ì•„, ì§€ê¸ˆì€ ì½ì„ íƒ€ì´ë°ì´ ì•„ë‹Œê°€? ë‹¤ìŒì— ì½ì–´ì•¼ì§€.', type:'B' }
    ]},
    { id:'Q4', title:'ëª…ëŒ€ì‚¬ë¥¼ ë°œê²¬í•˜ë©´?', options:[
      { text:'a. ì´ê±´ ì¸ìƒ ë¬¸ì¥! ì¸ë±ìŠ¤ ë¶™ì´ê³  ê¸°ë¡í•´ì•¼ì§€', type:'A' },
      { text:'b. ìŒ.. ì¢‹ë„¤...(ê·¸ëƒ¥ ë§ˆìŒì—ë§Œ ë‹´ì•„ë‘”ë‹¤)', type:'B' }
    ]},
    { id:'Q5', title:'í´ë¼ì´ë§¥ìŠ¤ì—ì„œ ì ì´ ì˜¬ ë•Œ?', options:[
      { text:'a. ì¡¸ë¦¬ë©´ ê·¸ëƒ¥ ì”ë‹¤ (ë…ì„œ=ìˆ˜ë©´ì œ)', type:'A' },
      { text:'b. ì´ì•¼ê¸° íë¦„ ì§€ì¼œ! ëê¹Œì§€ ë²„í‹´ë‹¤', type:'B' }
    ]},
    { id:'Q6', title:'ì±…ì„ ê³ ë¥¼ ë•Œ ë‚˜ëŠ”?', options:[
      { text:'a. ê°ìœ¼ë¡œ ê³ ë¥¸ë‹¤ (í‘œì§€, ì œëª©, ëŠë‚Œ!)', type:'A' },
      { text:'b. ë¦¬ë·°/ì¶”ì²œì„ ê¼¼ê¼¼íˆ ë³´ê³  ê³ ë¥¸ë‹¤', type:'B' }
    ]},
    { id:'Q7', title:'ì±…ì— ë¬¼ì´ë‚˜ ì–¼ë£©ì´ ë¬»ì—ˆë‹¤ë©´?', options:[
      { text:'a. ë§ˆìŒì˜ ìƒì²˜, ìƒˆë¡œ ì‚¬ê³  ì‹¶ë‹¤', type:'A' },
      { text:'b. ì¶”ì–µì˜ í”ì ì´ë¼ ìƒê°í•œë‹¤', type:'B' }
    ]},
    { id:'Q8', title:'ë‚˜ëŠ” ë‚´ ì±…ì— ì´ë¦„ì„...', options:[
      { text:'a. ê¼­ ì ëŠ”ë‹¤(ë‚´ ì†Œì¤‘í•œ ì±…ì´ë‹ˆê¹Œ)', type:'A' },
      { text:'b. ì ˆëŒ€ ì•ˆ ì ëŠ”ë‹¤(ê¹¨ë—í•´ì•¼í•´!)', type:'B' }
    ]},
    { id:'Q9', title:'ë“±ì¥ì¸ë¬¼ì´ ë„ˆë¬´ ë§ë‹¤ë©´?', options:[
      { text:'a. ë©”ëª¨í•˜ê±°ë‚˜ í‘œì‹œí•´ë‘”ë‹¤', type:'A' },
      { text:'b. ê·¸ëƒ¥ ê°ìœ¼ë¡œ ê¸°ì–µí•œë‹¤', type:'B' }
    ]},
    { id:'Q10', title:'ì¹œêµ¬ê°€ ë‚´ê²Œ ì±…ì„ ë¹Œë ¤ë‹¬ë¼ í•˜ë©´?', options:[
      { text:'a. ê°™ì´ ì½ì! ê¸°êº¼ì´ ë¹Œë ¤ì¤€ë‹¤', type:'A' },
      { text:'b. ì±… í—¤ì§€ë©´ ì†ìƒí•´â€¦ ì‚´ì§ ë§ì„¤ì¸ë‹¤', type:'B' }
    ]}
  ];

  // =============== ì‹œì‘ í™”ë©´ (Firebase ì—†ì–´ë„ ë Œë”) ===============
  function renderStart(){
    appEl.innerHTML = `
      <div class="grid">
        <section class="card pad">
          <div class="pill">ì—­í•  ì„ íƒ</div>
          <h2 style="margin:.4rem 0 0">í˜¸ìŠ¤íŠ¸ë¡œ ë°© ë§Œë“¤ê¸° / ì°¸ê°€ìë¡œ ì…ì¥</h2>
          <div class="row" style="margin-top:12px">
            <div class="col">
              <input id="hostName" type="text" placeholder="í˜¸ìŠ¤íŠ¸ ì´ë¦„(ì˜ˆ: êµì‚¬/ì‚¬íšŒì)" />
              <button class="btn block" id="mkroom" style="margin-top:8px">ë°© ë§Œë“¤ê¸°</button>
            </div>
            <div class="col">
              <input id="code" type="text" placeholder="ë°© ì½”ë“œ(ì˜ˆ: ABC123)" />
              <input id="name" type="text" placeholder="ë‚´ ì´ë¦„(ì°¸ê°€ì)" style="margin-top:8px" />
              <button class="btn block" id="join" style="margin-top:8px">ì°¸ê°€ìë¡œ ì…ì¥</button>
            </div>
          </div>
          <div class="notice">Firestore ì¤€ë¹„ ìƒíƒœ: <b>${firebaseReady?'ì •ìƒ ì—°ê²°':'ë¯¸ì—°ê²°(í…ŒìŠ¤íŠ¸ ê·œì¹™ ê¶Œì¥)'}</b></div>
        </section>
        <aside class="card pad">
          <div class="pill">TIP</div>
          <p class="muted">ì°¸ê°€ìëŠ” íœ´ëŒ€í°ì—ì„œ ì´ í˜ì´ì§€ ë§í¬ë¥¼ ì—´ê³ , <b>ë°© ì½”ë“œ</b>ì™€ <b>ìê¸° ì´ë¦„</b>ë§Œ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤.</p>
        </aside>
      </div>
    `;

    // ì•ˆì „í•œ í•¸ë“¤ëŸ¬(ì—ëŸ¬ ì•Œë¦¼ ì¶”ê°€)
    $('#mkroom').addEventListener('click', async ()=>{
      if(!firebaseReady) return warn('Firebaseê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì½˜ì†” ì„¤ì •ê³¼ Firestore ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”.');
      const name = $('#hostName').value.trim()||'Host';
      try { await createRoom(name); }
      catch(e){ alert('ë°© ë§Œë“¤ê¸° ì‹¤íŒ¨: ' + (e?.message||e)); console.error(e); }
    });

    $('#join').addEventListener('click', async ()=>{
      if(!firebaseReady) return warn('Firebaseê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì½˜ì†” ì„¤ì •ê³¼ Firestore ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”.');
      const code = $('#code').value.trim().toUpperCase();
      const name = $('#name').value.trim()||'ì°¸ê°€ì';
      if(!code) return alert('ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
      try { await joinRoom(code, name); }
      catch(e){ alert('ì…ì¥ ì‹¤íŒ¨: ' + (e?.message||e)); console.error(e); }
    });
  }

  function warn(msg){
    banner.innerHTML = `<div class="error">âš ï¸ ${msg}</div>`;
    console.error(msg);
  }

  // =============== Firebase ì—°ê²° (ì§€ì—° ì‹œë„) ===============
  (function connectFirebase(){
    try{
      const cfg = {
        apiKey: "AIzaSyApSfouaSStrJ7YKjjU-V3YByqO0cd_AIc",
        authDomain: "balancegame-43c9b.firebaseapp.com",
        projectId: "balancegame-43c9b",
        storageBucket: "balancegame-43c9b.appspot.com", /* storageëŠ” ì•ˆ ì¨ë„ ë¬´ë°© */
        messagingSenderId: "334047765801",
        appId: "1:334047765801:web:50a37aa30ed5b0f06bc338",
        measurementId: "G-GEWHJK9SP3"
      };
      if(!(window.firebase && firebase.initializeApp)){
        warn("Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (CDN ì°¨ë‹¨/ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ê°€ëŠ¥)");
        renderStart(); return;
      }
      const appFB = firebase.initializeApp(cfg);
      db = firebase.firestore();
      firebaseReady = true;
      // ì½ê¸° í…ŒìŠ¤íŠ¸(ê¶Œí•œ í™•ì¸)
      db.collection("_ping").limit(1).get()
        .then(()=>renderStart())
        .catch(e=>{ warn("Firestore ì ‘ê·¼ ì‹¤íŒ¨: ê·œì¹™ ë˜ëŠ” í”„ë¡œì íŠ¸ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.\n"+(e?.message||e)); renderStart(); });
    }catch(e){
      warn("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜: " + (e?.message||e));
      renderStart();
    }
  })();

  // =============== Firestore ë™ì‘ í•¨ìˆ˜ ===============
  async function createRoom(hostName){
    const id = code6();
    const secret = Math.random().toString(36).slice(2,10);
    await db.collection('rooms').doc(id).set({
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      currentIndex: -1,
      started: false,
      hostId: null,
      secret,
    });
    room.id = id; room.secret = secret;
    me = { id: uid(), name: hostName||'Host', role:'host' };
    await db.collection('rooms').doc(id).collection('players').doc(me.id).set({
      name: me.name, role:'host',
      joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    await db.collection('rooms').doc(id).update({ hostId: me.id });
    listenRoom();
  }

  async function joinRoom(code, name){
    const snap = await db.collection('rooms').doc(code).get();
    if(!snap.exists){ alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°© ì½”ë“œì…ë‹ˆë‹¤.'); return; }
    room.id = code; room.secret = snap.data().secret || null;
    me = { id: uid(), name: name||'ì°¸ê°€ì', role:'player' };
    await db.collection('rooms').doc(code).collection('players').doc(me.id).set({
      name: me.name, role:'player',
      joinedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    listenRoom();
  }

  function listenRoom(){
    if(unsubRoom) unsubRoom();
    unsubRoom = db.collection('rooms').doc(room.id).onSnapshot(doc=>{
      if(!doc.exists){ warn('ë°©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'); renderStart(); return; }
      renderGame(doc.data());
    });
    if(unsubPlayers) unsubPlayers();
    unsubPlayers = db.collection('rooms').doc(room.id).collection('players').orderBy('joinedAt','asc')
      .onSnapshot(()=>{/* renderGame ë‚´ë¶€ì—ì„œ ì¬ì¡°íšŒ */});
  }

  async function fetchPlayers(){
    const qs = await db.collection('rooms').doc(room.id).collection('players').orderBy('joinedAt','asc').get();
    return qs.docs.map(d=>({ id:d.id, ...d.data() }));
  }
  async function answersFor(index){
    const qs = await db.collection('rooms').doc(room.id).collection('answers').where('qIndex','==',index).get();
    return qs.docs.map(d=>d.data());
  }
  async function startGame(){ await db.collection('rooms').doc(room.id).update({ started:true, currentIndex:0 }); }
  async function nextQuestion(cur){
    const next = cur+1;
    await db.collection('rooms').doc(room.id).update({ currentIndex: Math.min(next, QUESTIONS.length) });
  }
  async function pick(index, type){
    const docId = `${me.id}_${index}`;
    return db.collection('rooms').doc(room.id).collection('answers').doc(docId).set({
      playerId: me.id, name: me.name, qIndex: index, type,
      at: firebase.firestore.FieldValue.serverTimestamp(),
    }, { merge:true });
  }

  // =============== ê²Œì„ í™”ë©´ ===============
  async function renderGame(roomDoc){
    const players = await fetchPlayers();
    const cur = roomDoc.currentIndex;

    const headerHTML = `
      <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:10px">
        <div><span class="pill">ë°© ì½”ë“œ</span> <b style="letter-spacing:1px">${room.id}</b></div>
        <div><span class="pill">ì¸ì›</span> ${players.length}ëª…</div>
      </div>
    `;

    // ëŒ€ê¸°ì‹¤
    if(cur < 0 || !roomDoc.started){
      appEl.innerHTML = `
        ${headerHTML}
        <div class="grid">
          <section>
            <div class="pill">ëŒ€ê¸°ì‹¤</div>
            <h2 style="margin:.4rem 0 0">ì°¸ê°€ìë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘â€¦</h2>
            <p class="muted">ë§í¬ë¥¼ ê³µìœ í•˜ê³  ë°© ì½”ë“œë¥¼ ì•Œë ¤ ì£¼ì„¸ìš”.</p>
            <div class="card pad" style="margin-top:10px">
              <h3 style="margin:.2rem 0 .6rem">ì°¸ê°€ì ëª©ë¡</h3>
              <div>${players.map(p=>`<span class="tag">${p.name}${p.role==='host'?' (í˜¸ìŠ¤íŠ¸)':''}</span>`).join(' ')||'<span class="muted">ì•„ì§ ì—†ìŒ</span>'}</div>
            </div>
            ${me.role==='host'?'<button class="btn" id="start">ê²Œì„ ì‹œì‘</button>':''}
          </section>
          <aside class="card pad">
            <div class="pill">í˜¸ìŠ¤íŠ¸ ì•ˆë‚´</div>
            <p class="muted">ëª¨ë‘ ì…ì¥í•˜ë©´ <b>ê²Œì„ ì‹œì‘</b>ì„ ëˆŒëŸ¬ ì²« ë²ˆì§¸ ë¬¸ì œë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
          </aside>
        </div>
      `;
      if(me.role==='host') $('#start').addEventListener('click', startGame);
      return;
    }

    // ê²°ê³¼ í™”ë©´
    if(cur >= QUESTIONS.length){
      const allAnswers = await db.collection('rooms').doc(room.id).collection('answers').get();
      const answers = allAnswers.docs.map(d=>d.data());
      const qCount = QUESTIONS.length;

      function matchesBetween(aId,bId){
        let same=0; for(let i=0;i<qCount;i++){
          const Pa = answers.find(x=>x.playerId===aId && x.qIndex===i);
          const Pb = answers.find(x=>x.playerId===bId && x.qIndex===i);
          if(Pa && Pb && Pa.type===Pb.type) same++;
        }
        return same;
      }
      function matchMessage(m){
        if(m<=2) return { title:'ì±…ì€ ê°™ì´ ì½ì§€ë§Œ... ë§ˆìŒì€ í‰í–‰ì„  ğŸ’«', desc:'ë„ˆí¬ëŠ” ì™„ì „ ì •ë°˜ëŒ€ ë…ì„œ ì§ê¿! í•œ ëª…ì€ ì±… ëª¨ì„œë¦¬ ì ‘ê³ , í•œ ëª…ì€ ì ‘ëŠ” ì‚¬ëŒ ë³´ë©´ ê¸°ì ˆí•˜ëŠ” íƒ€ì…. í•˜ì§€ë§Œ ì´ëŸ° ì¡°í•©ì´ ì œì¼ ì¬ë°Œì§€! ë§¤ë²ˆ í† ë¡  ì•„ë‹Œ í† í¬ì‡¼ ê°œì¥!' };
        if(m<=5) return { title:'ë‹¤ë¥´ì§€ë§Œ ë¬˜í•˜ê²Œ í†µí•˜ëŠ” ë…ì„œ ì¹œêµ¬ ğŸ“–', desc:'ë‘˜ ë‹¤ ì±…ì€ ì¢‹ì•„í•˜ì§€ë§Œ ì ‘ê·¼ ë°©ì‹ì´ ë‹¬ë¼ìš”. í•œ ëª…ì€ â€˜ì±…ì€ ì‹ ì„±í•œ ì¡´ì¬â€™, ë‹¤ë¥¸ í•œ ëª…ì€ â€˜ì±…ì€ ìƒí™œ ì† ì¹œêµ¬â€™. ê·¸ë˜ë„ ì„œë¡œì˜ ì·¨í–¥ì„ ì¡´ì¤‘í•˜ëŠ” ì´ìƒì ì¸ ë…ì„œ ë“€ì˜¤!' };
        if(m<=8) return { title:'ê°™ì´ ì±… ê³ ë¥´ê³  ê°™ì´ íë§í•˜ëŠ” ì°ë…ì„œë©”ì´íŠ¸ ğŸŒ¿', desc:'ì±… ê³ ë¥¼ ë•Œ, ì½ì„ ë•Œ, ì‹¬ì§€ì–´ ì±… ì½ëŠ” ìì„¸ê¹Œì§€ ë¹„ìŠ·í•´ìš”. ë„ì„œê´€ ê°€ë©´ ë‘˜ ë‹¤ ê°™ì€ ì½”ë„ˆì—ì„œ ë§ˆì£¼ì¹  í™•ë¥  98%!' };
        return { title:'ë…ì„œ ì†Œìš¸ë©”ì´íŠ¸ ë°œê²¬! ğŸ’', desc:'ì´ ì •ë„ë©´ ê±°ì˜ ì±… ì†ì—ì„œë„ ë§Œë‚˜ì•¼ í•  ìš´ëª…ì´ì•¼. ë‘˜ ë‹¤ ì±… ë„˜ê¸°ëŠ” íƒ€ì´ë°ë„, ì±…ì— ì† ë² ì´ëŠ” ì†ê°€ë½ ë§ˆë””ë„ ë˜‘ê°™ì„ ë“¯!' };
      }

      const pairs = [];
      if(players.length>=2){
        for(let i=0;i<players.length;i++){
          for(let j=i+1;j<players.length;j++){
            const a=players[i], b=players[j];
            const m = matchesBetween(a.id,b.id);
            pairs.push({a,b,matched:m,msg:matchMessage(m)});
          }
        }
      }

      // ìœ ì‚¬ë„ í‘œ
      function sameCount(a,b){
        let same=0; for(let i=0;i<qCount;i++){
          const Pa = answers.find(x=>x.playerId===a && x.qIndex===i);
          const Pb = answers.find(x=>x.playerId===b && x.qIndex===i);
          if(Pa && Pb && Pa.type===Pb.type) same++;
        }
        return same;
      }
      let table = '<table class="table"><thead><tr><th>ìƒëŒ€</th>';
      players.forEach(p=>table+=`<th>${p.name}</th>`);
      table += '</tr></thead><tbody>';
      players.forEach(r=>{
        table += `<tr><th>${r.name}</th>`;
        players.forEach(c=>{
          if(r.id===c.id) table+='<td>â€”</td>';
          else { const s=sameCount(r.id,c.id), rate=Math.round((s/qCount)*100); table+=`<td>${s}/${qCount} (${rate}%)</td>`; }
        });
        table += '</tr>';
      });
      table += '</tbody></table>';

      const pairCards = pairs.map(p=>`
        <div class="card pad" style="margin-bottom:10px">
          <div class="pill" style="background:rgba(255,255,255,.12)">${p.a.name} Ã— ${p.b.name}</div>
          <h3 style="margin:.4rem 0 0">ì¼ì¹˜ ${p.matched}/${qCount}</h3>
          <p class="muted" style="margin:.2rem 0 .4rem">${p.msg.title}</p>
          <p>${p.msg.desc}</p>
        </div>
      `).join('');

      appEl.innerHTML = `
        ${headerHTML}
        <div class="grid">
          <section>
            <div class="pill">ê²Œì„ ì¢…ë£Œ</div>
            <h2 style="margin:.4rem 0 0">ìš°ë¦¬ì˜ ê²°ê³¼</h2>
            <div class="card pad" style="margin-top:10px">
              <h3 style="margin:.2rem 0 .6rem">ì·¨í–¥ ê²¹ì¹¨(ê°™ì€ íƒ€ì… ì„ íƒ ë¹„ìœ¨)</h3>
              ${table}
            </div>
            ${pairs.length? `<div class="card pad" style="margin-top:10px"><h3 style="margin:.2rem 0 .6rem">í˜ì–´ ë§¤ì¹­ ê²°ê³¼</h3>${pairCards}</div>`:''}
            <div class="row" style="margin-top:12px">
              <button class="btn" id="restart">ë‹¤ì‹œ í•˜ê¸°(ìƒˆ ë°©)</button>
            </div>
          </section>
          <aside class="card pad">
            <h3 style="margin:.2rem 0 .6rem">ë¬¸í•­ë³„ ì„ íƒ ìš”ì•½</h3>
            <div style="max-height:60vh;overflow:auto">
              ${QUESTIONS.map((q,i)=>`<div class="tag">ë¬¸í•­ ${i+1}. ${q.title}</div>`).join('')}
            </div>
          </aside>
        </div>
      `;
      $('#restart').addEventListener('click',()=>location.reload());
      return;
    }

    // ì§„í–‰ í™”ë©´
    const q = QUESTIONS[cur];
    const picks = await answersFor(cur);
    const myPick = picks.find(a=>a.playerId===me.id)?.type || null;
    const tallyNow = {A:0,B:0}; picks.forEach(a=>tallyNow[a.type]=(tallyNow[a.type]||0)+1);

    appEl.innerHTML = `
      ${headerHTML}
      <div class="progress"><div class="bar" style="width:${Math.round((cur/QUESTIONS.length)*100)}%"></div></div>
      <div class="qnum">ë¬¸í•­ ${cur+1} / ${QUESTIONS.length}</div>
      <h3 class="qtitle">${q.title}</h3>
      <div class="grid">
        <section class="card pad">
          ${q.options.map(o=>`
            <button class="btn block opt ${myPick===o.type?'selected':''}" data-type="${o.type}">${o.text}</button>
          `).join('')}
          <div class="notice" style="margin-top:10px">ì„ íƒ í›„ í˜¸ìŠ¤íŠ¸ê°€ â€œë‹¤ìŒâ€ìœ¼ë¡œ ë„˜ê¹ë‹ˆë‹¤.</div>
          <div class="row" style="margin-top:14px;justify-content:flex-end">
            ${me.role==='host'?'<button class="btn" id="next">ë‹¤ìŒ</button>':''}
          </div>
        </section>
        <aside class="card pad">
          <h3 style="margin:.2rem 0 .6rem">ì‹¤ì‹œê°„ ì§‘ê³„</h3>
          <div class="row">
            <span class="tag">A: ${tallyNow.A||0}</span>
            <span class="tag">B: ${tallyNow.B||0}</span>
          </div>
          <h3 style="margin:.8rem 0 .6rem">ì°¸ê°€ì</h3>
          <div>${players.map(p=>`<span class="tag">${p.name}${p.role==='host'?'(í˜¸ìŠ¤íŠ¸)':''}</span>`).join(' ')}</div>
        </aside>
      </div>
    `;

    // ë²„íŠ¼ í´ë¦­: ì‹œê°ì  ì„ íƒ + Firestore ì €ì¥(ì‹¤íŒ¨ ì‹œ ì•Œë¦¼)
    appEl.querySelectorAll('.opt').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        // ì‹œê°ì  ì„ íƒ í‘œì‹œ
        appEl.querySelectorAll('.opt').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');

        if(!firebaseReady || !db){ alert(`(í…ŒìŠ¤íŠ¸) "${btn.textContent}" ì„ íƒë¨`); return; }

        try {
          await pick(cur, btn.dataset.type);
        } catch(e){
          alert('ì„ íƒ ì €ì¥ ì‹¤íŒ¨: ' + (e?.message||e));
          console.error(e);
        }
      });
    });
    if(me.role==='host'){ $('#next').addEventListener('click', ()=>nextQuestion(cur)); }
  }

  // ì²« ë Œë”
  renderStart();

  // ì „ì—­ ì—ëŸ¬ ë°°ë„ˆ
  window.addEventListener('error', e=>{ warn("ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜: " + (e?.message||e)); });
  </script>

  <!-- â–¼ Firestore ê·œì¹™(í…ŒìŠ¤íŠ¸ìš© ìƒ˜í”Œ) â€“ ì½˜ì†” > Firestore Database > Rulesì— ì„¤ì • í›„ Publish
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /{document=**} { allow read, write: if true; }  // ë°ëª¨/í…ŒìŠ¤íŠ¸ì—ë§Œ ì‚¬ìš© (ìš´ì˜ ê¸ˆì§€)
    }
  }
  â–² -->
</body>
</html>
